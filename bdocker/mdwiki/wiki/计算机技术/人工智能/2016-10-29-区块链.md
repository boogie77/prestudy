---
layout: post
title: 区块链
lead: 区块链核心技术演进之路
date: 2016-10-29T00:00:00.000Z
categories: 人工智能
tagline: 区块链
tags:
  - 区块链
---

==很少有新兴事物如比特币般，支持者和反对者如此泾渭分明==。望文生义，很容易得出这个东西毫无价值的结论。"币"这个词虽然准确的描述了其金融属性，但由于过于形象，使得大多数人对于它如何能与完全虚拟的"比特"关联起来而大惑不解。其实比特币本没有"币"，有的只是一个分布式的、无中心节点的"交易账本"系统。如果货币数字化是不可逆转的趋势，其实我们需要的，仅仅是一份数字化的账本。

=="区块"是比特币的核心概念，它是这份"账本"的基本单位==。**它由分布在全球各角落的计算机不停的创造出来，打包刚刚发生的交易信息（大约每10分钟一个），并通过不可逆的算法和前后区块首尾相连，组成了一份全球唯一的，不可逆的，可能也无法终止的巨大账本**。

# 揭秘比特币和区块链

## 什么是区块链？

随着信息技术的发展，人们的生活逐渐网络化，数字化。人类社会因此发生着深刻的变化。对数字货币的探索，就是在这样的背景下应运而生的。其实相关的研究在上世纪八九十年代，就开始了。

在数字货币的探索实践中，比特币是目前表现最好的一个。说到比特币的缘起，就不得不谈到一个略显神秘的团体：==密码朋克（CypherPunk）==。这个团体是**密码天才们的松散联盟**。在比特币的创新中，大量借鉴了密码朋克成员的贡献。

密码朋克本身就是数字货币最早的传播者，在其电子邮件组中，常见关于数字货币的讨论，并有一些想法付诸实践。在比特币之前，有很多失败的尝试。在这里我们简要列举一些之前探路者。

- **亚当·贝克**（Adam Back）是一位英国的密码学家，1997年，他发明了**哈希现金（hashcash）**[i]，其中用到了==工作量证明机制（proof of work）==。这个机制的原型是用于解决互联网垃圾信息问题的[ii]。**工作量证明机制后来成为比特币的核心要素之一**。

- **哈伯和斯托尼塔**（Haber and Stornetta）在1997年提出了一个==用时间戳的方法保证数字文件安全的协议==[iii]，**这个协议成为比特币区块链协议的原型**。

- **戴伟**（W Dai）是一位兴趣广泛的密码学专家，他在1998年发明了**B-money**[iv]，==B-money强调点对点的交易和不可更改的交易记录==。不过在B-money中，每台计算机各自单独书写交易记录，这很容易造成系统被账本的不一致。戴伟为此设计了复杂的奖惩机制以防止作弊，但是并没有能从根本上解决问题。**中本聪发明比特币的时候，借鉴了很多戴伟的设计，并和戴伟有很多邮件交流**。

- **哈尔·芬尼**（Hal Finney））是PGP公司的一位顶级开发人员，也是密码朋克运动早期和重要的成员。2004年，芬尼推出了自己版本的电子货币，在其中采用了==可重复使用的工作量证明机制（RPOW）==。**哈尔·芬尼是第一笔比特币转账的接受者，在比特币发展的早期与中本聪有大量互动与交流**。由于身患绝症，哈尔·芬尼已于2014年去世。

### 比特币的诞生

2008年9月，以雷曼兄弟的倒闭为开端，金融危机在美国爆发并向全世界蔓延。为应对危机，各国政府采取量化宽松等措施，救助由于自身过失、陷入危机的大型金融机构。这些措施带来了广泛的质疑，并一度引发了"占领华尔街"运动。

2008年10月31日纽约时间下午2点10分，在一个普通的密码学邮件列表中，几百个成员均收到了自称是中本聪的人的电子邮件[v]，"==我一直在研究一个新的电子现金系统，这完全是点对点的，无需任何可信的第三方=="，然后他将他们引向一个九页的白皮书，其中描述了一个新的货币体系。同年11月16日，中本聪放出了比特币代码的先行版本[vi]。

**2009年1月3日，中本聪在位于芬兰赫尔辛基的一个小型服务器上挖出了比特币的第一个区块----创世区块**（==Genesis Block==），并获得了首矿"奖励----50个比特币。在创世区块中，中本聪写下这样一句话：

> "The Times 03/Jan/2009 Chancellor on brink of second bailout for banks"

> "财政大臣站在第二次救助银行的边缘"

这句话是当天泰晤士报头版的标题。**中本聪将它写进创世区块，不但清晰地展示着比特币的诞生时间，还表达着对旧体系的嘲讽**。

如今，比特币已经成为数字货币领域的翘楚，拥有数十亿美元的市值，但中本聪却于2010年选择隐退。中本聪是谁，对每一个开始了解比特币的人，都是感兴趣的话题。从《纽约客》到《新闻周刊》，媒体们找到了数个自称是中本聪，或者被认为是中本聪的人。但无一例外，这些发现都因为可信度不足，遭到了读者甚至是中本聪本人的否定。==中本聪是谁？也许我们永远不得而知==。

### 比特币与区块链

比特币已经在争议中走过了7年多的历程。在历史上，很少有这样一种东西，人们对待它的态度如此泾渭分明，==支持者认为它将改变世界，反对者认为它毫无价值==。望文生义，很容易得出后一个结论。"币"这个词虽然准确的描述了其金融属性，但由于过于形象，使得大多数人对于它如何能与完全虚拟的"比特"关联起来而大惑不解。

其实，**在比特币的系统中，最重要的并不是"币"的概念，而是一个没有中心存储机构的"账本"的概念**。"币"只是在这个账本上使用的记账单位。可以这么说，比特币本质就是一个基于互联网的去中心化账本，而区块链就是这个账本的名字。这里我们可以做一个形象的类比，假如区块链是一个实物账本，一个区块就相当于账本中的一页，区块中承载的信息，就是这一页上记载的交易内容。

==区块链是比特币的核心与基础架构，是一个去中心化的账本系统==。

既然区块链是个账本，这个账本和我们传统的账本有什么不同？我们知道，账本上的内容必须是唯一的，这导致记账天然是中心化的行为。在通讯手段不发达的时代如此，在现今的信息时代也是如此。然而，中心化的记账却有一些显而易见的弱点：一旦这个中心出现问题，如被篡改、被损坏，整个系统就会面临危机乃至崩溃。

那么问题来了----我们能不能==构建一个去中心化的不依赖任何第三方的但却可信的记账系统呢==？去中心记账可以克服中心化账本的弱点，但是想实现这样的账本系统绝非易事。

在数字时代，负责记账的自然是计算机。这里，我们把记账系统中接入的每一台计算机称为"节点"。去中心化就是没有中心，也就是说参与到这个系统中的每个节点都是中心。从设计账本系统的角度，就是需要每个节点都保存一份完整的账本。然而，**由于一致性的要求，每个节点却不能同时记账。因为节点所处的环境不同，接收到的信息自然不同，如果同时记账的话，必然会导致账本的不一致，造成混乱**。

既然节点不能同时记账，那我们就不得不选择哪个节点拥有记账的权力。但是，如果指定某些特殊节点拥有记账的权力，势必又会与我们去中心化的初衷相违背。

这似乎成了不可能解决的问题。

### 竞争记账和激励机制

==中本聪设计的比特币区块链通过竞争记账的方式解决了去中心化的记账系统的一致性问题==。

前面提到，节点可以理解为接入系统中的计算机，而==所谓的竞争记账，就是以每个节点的计算能力即"算力"来竞争记账权的一种机制==。在比特币系统中，大约每十分钟进行一轮算力竞赛（==算力大小会决定赢得一轮竞争的概率，算力高的节点赢得算力竞争的概率更大==），竞赛的胜利者，就获得一次记账的权力，这样，一定时间内，只有竞争的胜利者才能记账并向其他节点同步新增账本信息。

那么，在一个去中心化的系统中，谁有权判定竞争的结果呢？比特币系统是通过一个称为"**工作量证明**"（==proof of work, POW==）的机制完成的。举个简单的例子，比如说要生产一些玩具，早上起来我给你一些零件，晚上回来，看到需要的玩具摆在桌上，虽然我没有从早到晚盯着你做玩具的过程，我也能确定你确实做了这么多工作。这就是工作量证明简单的理解----通过一个（人人都可以验证的）特定的结果就能确认（竞争的）参与者完成了相应的工作量。（关于POW的机制与实现细节，会在接下来的文章中详述）

算力竞争是要付出成本的，没有激励，节点就没有进行竞争的动力。在中本聪的设计里，==每轮竞争胜出并完成记账的节点，将可以获得系统给予的一定数量的比特币奖励==[vii]。而这个奖励的过程，同时也是比特币的发行过程。这种设计相当巧妙 ---- ==它将竞争的激励机制与货币的发行完美结合到一起，在引入竞争的同时，解决了去中心化货币系统中发行的难题==。

在这个系统中，每一个节点只需要根据自身利益行事。**出于"自私"的目的进行的竞争，最终造就了保护系统安全的庞大算力基础**。在这样精巧的安排下，比特币获得了越来越多的信任，和越来越高的价值，进而又吸引了更多的资源投入其中，成为一个正向循环的经济系统。

正因为比特币通过区块链的机制造就了这样一个正向循环的经济系统，才会在没有强大的中心化机构推动的情况下，自然的生长出来并发展壮大。

读到这里，显然我们会发现，==虽然区块链脱胎于比特币，但区块链无论作为一个系统还是作为一项技术，它的应用领域及发展潜力，将远不止货币==。之后的文章，我们会通过更加深入的分析与讲解，带您深入到区块链的原理与实现细节。

## 挖矿的本质是什么？

> 最近几天，聊聊架构都会发区块链相关的文章，期望通过整个的系列内容，能向社区普及区块链和比特币相关的知识。昨天的第一篇文章，作者介绍了区块链的背景知识，并且用一句话总结了比特币和区块链之间的关系：区块链是比特币的核心与基础架构，是一个去中心化的账本系统。今天这篇文章，将会重点介绍我们经常提到的挖矿，也就是工作量证明。理解工作量证明机制，将为我们进一步理解比特币区块链的共识机制奠定基础。

**工作量证明（Proof Of Work，简称POW），简单理解就是一份证明，用来确认你做过一定量的工作**。监测工作的整个过程通常是极为低效的，而通过对工作的结果进行认证来证明完成了相应的工作量，则是一种非常高效的方式。比如现实生活中的毕业证、驾驶证等等，也是通过检验结果的方式（通过相关的考试）所取得的证明。

==工作量证明系统（或者说协议、函数），是一种应对拒绝服务攻击和其他服务滥用的经济对策==。它要求发起者进行一定量的运算，也就意味着需要消耗计算机一定的时间。这个概念由Cynthia Dwork 和Moni Naor 1993年在学术论文中首次提出。而工作量证明（POW）这个名词，则是在1999年 Markus Jakobsson 和Ari Juels的文章中才被真正提出。

**哈希现金是一种工作量证明机制，它是亚当·贝克（Adam Back）在1997年发明的，用于抵抗邮件的拒绝服务攻击及垃圾邮件网关滥用**。在比特币之前，哈希现金被用于垃圾邮件的过滤，也被微软用于hotmail/exchange/outlook等产品中（微软使用一种与哈希现金不兼容的格式并将之命名为电子邮戳）。

哈希现金也被哈尔·芬尼以可重复使用的工作量证明（RPOW）的形式用于一种比特币之前的加密货币实验中。另外，戴伟的B-money、尼克·萨博的比特金（Bit-Gold）这些比特币的先行者，都是在哈希现金的框架下进行挖矿的。

### 哈希函数

==哈希函数（Hash Function），也称为散列函数，给定一个输入x，它会算出相应的输出H(x)==。**哈希函数的主要特征是**：

- 输入x可以是任意长度的字符串
- 输出结果即H(x)的长度是固定的
- 计算H(x)的过程是高效的（对于长度为n的字符串x，计算出H(x)的时间复杂度应为O(n)）

**而对于比特币这种加密系统所使用的哈希函数，它需要另外具备以下的性质**：

- ==免碰撞==，即不会出现输入x≠y，但是H(x)=H(y)

  > - ==其实这个特点在理论上并不成立==，比如，比特币使用的SHA256算法，会有 2^256 种输出，如果我们进行 2^256 +1 次输入，那么必然会产生一次碰撞；
  > - 甚至从概率的角度看，进行 2^130 次输入就会有99%的可能发生一次碰撞。
  > - 不过我们可以计算一下，假设一台计算机以每秒10000次的速度进行哈希运算，要经过 10^27 年才能完成 2^128 次哈希！
  > - 甚至可以这么说，即便是人类制造的所有计算机自宇宙诞生开始一直运算到今天，发现碰撞的几率也是极其小的。

- 隐匿性，也就是说，对于一个给定的输出结果H(x)，想要逆推出输入x，在计算上是不可能的。
- ==不存在比穷举更好的方法，可以使哈希结果H(x)落在特定的范围==。

**以上特点是比特币的工作量证明系统可以正常运行的基石**。

### 工作量证明的基本原理

==工作量证明系统主要特征是客户端需要做一定难度的工作得出一个结果，验证方却很容易通过结果来检查出客户端是不是做了相应的工作==。**这种方案的一个核心特征是不对称性：工作对于请求方是适中的，对于验证方则是易于验证的**。它与验证码不同，验证码的设计出发点是易于被人类解决而不易被计算机解决。

下图表示的是工作量证明的流程：

![工作量证明流程](http://cdn.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part02/zh/resources/000.png)

举个例子，给定的一个基本的字符串"Hello, world!"，我们给出的工作量要求是，可以在这个字符串后面添加一个叫做nonce的整数值，对变更后（添加nonce）的字符串进行SHA256哈希运算，如果得到的哈希结果（以16进制的形式表示）是以"0000"开头的，则验证通过。为了达到这个工作量证明的目标。我们需要不停的递增nonce值，对得到的新字符串进行SHA256哈希运算。按照这个规则，我们需要经过4251次计算才能找到恰好前4位为0的哈希散列。

```
"Hello, world!0" => 1312af178c253f84028d480a6adc1e25e81caa44c749ec81976192e2ec934c64
"Hello, world!1" => e9afc424b79e4f6ab42d99c81156d3a17228d6e1eef4139be78e948a9332a7d8
"Hello, world!2" => ae37343a357a8297591625e7134cbea22f5928be8ca2a32aa475cf05fd4266b7
...
"Hello, world!4248" => 6e110d98b388e77e9c6f042ac6b497cec46660deef75a55ebc7cfdf65cc0b965
"Hello, world!4249" => c004190b822f1669cac8dc37e761cb73652e7832fb814565702245cf26ebb9e6
"Hello, world!4250" => 0000c3af42fc31103f1fdc0151fa747ff87349a4714df7cc52ea464e12dcd4e9
```

通过这个示例我们对工作量证明机制有了一个初步的理解。有的人会认为如果工作量证明只是这样的一个过程，那是不是只需要记住nonce为4521计算能通过验证就行了？当然不是的，这只是一个个例。

下面，我们将输入简单的变更为"Hello, world+整数值"，整数值取1到1000，也就是说，将输入变成一个由1000个值组成的数组："Hello, world!1、Hello, world!2......Hello, world!1000"。然后对数组中的每一个输入依次进行上面例子中要求的工作量证明----找到前导为4个0的哈希散列。

容易算出，预期大概要进行 2^16 次尝试（哈希值的伪随机特性使得我们可以做概率估算），才能得到4个前导0的哈希散列。而统计一下刚才进行的1000次计算的实际计算结果，我们会发现，进行计算的平均次数为66958次，十分接近 2^16 （65536）。在这个例子中，数学期望的计算次数，就是我们要求的"工作量"，==重复多次进行的工作量证明会是一个符合统计学规律的概率事件==。

统计输入的字符串与对应得到目标结果实际使用的计算次数列表如下：

```
Hello, world!1 => 42153
Hello, world!2 => 2643
Hello, world!3 => 32825
Hello, world!4 => 250
Hello, world!5 => 7300
...
Hello, world!995 => 164819
Hello, world!996 => 178486
Hello, world!997 => 22798
Hello, world!998 => 68868
Hello, world!999 => 46821
```

比特币体系里的工作量证明机制与上述示例类似，但要比它更复杂一些。

### 比特币中的工作量证明

**比特币网络中任何一个节点，如果想生成一个新的区块并写入区块链，必须解出比特币网络出的工作量证明的迷题**。这道题关键的三个要素是==工作量证明函数==、==区块==及==难度值==。工作量证明函数是这道题的计算方法，区块决定了这道题的输入数据，难度值决定了这道题的所需要的计算量。

#### 工作量证明函数

和我们上节例子中用到的哈希函数一样，==比特币系统中使用的工作量证明函正是SHA256==。

**SHA是安全散列算法（Secure Hash Algorithm）的缩写，是一个密码散列函数家族**。这一组函数是由美国国家安全局（NSA）设计，美国国家标准与技术研究院（NIST） 发布的，主要适用于数字签名标准。SHA256就是这个函数家族中的一个，是输出值为256位的哈希算法。**到目前为止，还没有出现对SHA256算法的有效攻击**。

#### 区块

==比特币的区块由区块头及该区块所包含的交易列表组成==。区块头的大小为80字节，**由4字节的版本号**、**32字节的上一个区块的散列值**、**32字节的Merkle Root Hash**、**4字节的时间缀（当前时间）**、**4字节的当前难度值**、**4字节的随机数组成**。**区块包含的交易列表则附加在区块头后面**，==其中的第一笔交易是coinbase交易，这是一笔为了让矿工获得奖励及手续费的特殊交易==。

区块的大致结构如图所示：

![区块结构图](http://cdn.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part02/zh/resources/001.png)

**拥有80字节固定长度的区块头，就是用于比特币工作量证明的输入字符串**。因此，为了使区块头能体现区块所包含的所有交易，在区块的构造过程中，需要将该区块要包含的交易列表，通过Merkle Tree（默克尔树）算法生成Merkle Root Hash，并以此作为交易列表的摘要存到区块头中。其中Merkle Tree的算法图解如下：

![MerkleTree算法图](http://cdn.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part02/zh/resources/002.png)

#### 难度值

==难度值（difficulty）是矿工们在挖矿时候的重要参考指标，它决定了矿工大约需要经过多少次哈希运算才能产生一个合法的区块==。比特币的区块大约每10分钟生成一个，如果要在不同的全网算力条件下，新区块的产生保持都基本这个速率，难度值必须根据全网算力的变化进行调整。简单地说，难度值被设定在无论挖矿能力如何，新区块产生速率都保持在10分钟一个。

**==难度的调整是在每个完整节点中独立自动发生的==**。**每2016个区块，所有节点都会按统一的公式自动调整难度，这个公式是由最新2016个区块的花费时长与期望时长（期望时长为20160分钟即两周，是按每10分钟一个区块的产生速率计算出的总时长）比较得出的，根据实际时长与期望时长的比值，进行相应调整（或变难或变易）**。也就是说，**如果区块产生的速率比10分钟快则增加难度，比10分钟慢则降低难度**。

这个公式可以总结为如下形式：

```
新难度值 = 旧难度值 * ( 过去2016个区块花费时长 / 20160 分钟 )
```

工作量证明需要有一个目标值。比特币工作量证明的目标值（Target）的计算公式如下：

```
目标值 = 最大目标值 / 难度值

其中最大目标值为一个恒定值：

0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
```

**目标值的大小与难度值成反比**。==比特币工作量证明的达成就是矿工计算出来的区块哈希值必须小于目标值==。

我们也可以简单理解成，**比特币工作量证明的过程，就是通过不停的变换区块头（即尝试不同的nouce值）作为输入进行SHA256哈希运算，找出一个特定格式哈希值的过程（即要求有一定数量的前导0）**。而要求的前导0的个数越多，代表难度越大。

#### 工作量证明的过程

我们可以把比特币矿工解这道工作量证明迷题的步骤大致归纳如下：

1. 生成Coinbase交易，并与其他所有准备打包进区块的交易组成交易列表，通过Merkle Tree算法生成Merkle Root Hash。

2. 把Merkle Root Hash及其他相关字段组装成区块头，将区块头的80字节数据（Block Header）作为工作量证明的输入。

3. 不停的变更区块头中的随机数即nonce的数值，并对每次变更后的的区块头做双重SHA256运算（即SHA256(SHA256(Block_Header))），将结果值与当前网络的目标值做对比，如果小于目标值，则解题成功，工作量证明完成。

该过程可以用下图表示：

![BlockPuzzle](http://cdn.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part02/zh/resources/003.png)

### 结语

比特币的工作量证明，就是我们俗称"挖矿"所做的主要工作。理解工作量证明机制，将为我们进一步理解比特币区块链的共识机制奠定基础。在之后的文章中，我们将会详细介绍比特币交易和区块的结构及同步过程、最长链机制以及达成共识的原理。

## 比特币的私钥、公钥与地址

> 最近几天，聊聊架构都在发区块链相关的内容，虽然阅读量并不如之前的其他内容高，但我还是会坚持发，因为推动这样的前沿技术的发展是我们理应做的事情。揭秘比特币和区块链系列文章现在已经更新到第三篇，下面是前两篇的链接。周末了，试试心态归零，准备开始新的一周。

==地址、交易、区块、网络是区块链数据里面最基本最重要的概念==。

- **地址用来标示一笔交易的支出方和接收方**。
- **所有的交易最终需要被记到统一的账本----区块链上**，而这个账本是通过区块确认并完成的。
- 每一个新区块，都会被打上时间戳，**最终生成依照时间前后排列并加以记录**。
- **每个独立节点之间又通过比特币网络来建立联系**。

==这样就为电子交易记录建立了一个去中心化、分布式的时间戳服务器系统==。

很复杂，在这一节，我们先讲地址。

### 公钥密码学

讲到地址，我们就不得不先说一说密码学，作为保护信息传输安全的技术手段，**密码在人类社会中的应用源远流长，凯撒密码是古典密码的典型代表，它的基本思想是通过字符的代换来实现加解密**。因此古典密码的安全性主要依赖加密算法本身的安全性，如果算法泄露了，要加密的信息也就没有秘密可言了。

如今密码学相关技术已经深入各个领域，它们的理论共识都遵循由奥古斯特•柯克霍夫在19世纪提出"==柯克霍夫原则=="---- ==密码系统应该即使被所有人知道其运作步骤，仍然是安全的==。**即算法是公开的，唯一需要保护的是密钥**。

1949年香农发表了《**保密系统的信息理论**》，为对称密码系统建立了理论基础，带来了**加密传输基于秘钥安全而不是基于加密算法安全的理论和技术变革**。==这是密码学发展的里程碑，标志着现代密码学时代的来临==。

公钥密码学兴起之前，对称加密是主流的加密模式，人们基于秘钥来对信息进行加解密，通常情况下，密钥越长，代表着密文被破解的难度越大。由于加密算法和解密算法都是同一模式，只有一把密钥保证加密数据的安全，因此这种加密算法也叫做"==对称加密算法=="。==对称加密有一个最大弱点：甲方必须把密钥告诉乙方，否则乙方无法解密==。**而保存和传递密钥，就成了最头疼的问题**。

公钥密码学是现代密码学最重要的进展。==公钥密码学可以在不直接传递密钥的情况下，完成密文的解密==。加密和解密可以使用不同的规则，只要这两种规则之间存在某种对应关系即可，系统的安全性既不依赖算法的保密，也不用直接传递密钥。基于这种公钥机制的思想，开始出现了一系列非对称加密算法。

1976年Whitfield Diffie & Martin Hellman首次提出了基于数学难题的公钥密码机制，1978年RSA公钥密码机制的出现，成为公钥密码的杰出代表并成为事实标准，在密码学史上创造了又一个新的里程碑。**90年代公钥密码学进一步发展，基于椭圆曲线乘法、素数幂等数学函数的公钥算法诞生，使得数字密钥和不可伪造的数字签名成为可能**。

==数据签名算法的核心在于证明数据的发送方是签名者发出的、不可抵赖，而不是待签名数据的保密性==。

下图比较说明非对称加密与对称加密算法的区别：

![非对称加密与对称加密算法的区别](http://cdn2.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part03/zh/resources/000.png)

**非对称加密需要两个（一对）密钥**：==公开密钥（publickey）和私有密钥（privatekey），用公钥对数据进行加密后，只有对应的私钥才能解密；反之如果私钥用于加密，则只有对应的公钥才能解密。通信双方无须交换密钥就可以建立保密通信==。

公钥算法用到的是私钥与公钥，他们和比特币体系中常常说到的地址有什么关系？==在比特币系统中，私钥由32字节的随机数组成，通过私钥可以算出公钥，公钥经过一系列哈希及编码算法就得到了比特币中的地址==。所以**地址其实是公钥的另一种表现形式，可以理解为公钥的摘要**。

### 相关的加密算法

**在私钥、公钥及地址的相关运算中，用到了基于secp256k1椭圆曲线乘法的签名算法、SHA-256、RIPEMD-160，和Base58编码**。

#### 椭圆曲线签名算法

椭圆曲线在密码学中的使用是在1985年由Neal Koblitz和Victor Miller分别独立提出的。它的**主要优势是在某些情况下它比其他的算法（比如RSA）使用更小的密钥但提供相当的或更高等级的安全性**。

**比特币使用了基于secp256k1椭圆曲线数学的公钥密码学算法**。它包含私钥与公钥，私钥用于对交易进行签名，将签名与原始数据发送给整个比特币网络，公钥则用于整个网络中的节点对交易有效性进行验证。签名算法保证了交易是由拥有对应私钥的人所发出的。

#### 哈希函数

SHA-256是一种哈希函数，已经在上一节的讲解中做了介绍，这里不再赘述[1]。

RIPEMD-160也是在生成地址时用到的一种哈希函数，其输出长度为20字节（160位）。**比特币用它减少标识接收方的字节数**。

#### Base58编码

可读性编码算法，类似古典密码学里的置换算法，理论上并不是密码学理论的核心内容。可读性编码算法不是为了保护数据的安全性，而是为了可读性。以二进制进行传输的信息是不具备可读性的，数字与字母组成的字符串才更容易被识别。==可读性编码不改变信息内容，只改变信息内容的表现形式==（**部分编码算法还加入了容错校验功能，以保证传输过程中数据的准确性和完整性**）。

Base64是常见的可读性编码算法，所谓Base64，即是说在编码过程中使用了64种字符：大写A到Z、小写a到z、数字0到9、"+"和"/"。

==Base58是Bitcoin中使用的一种编码方式，主要用于产生Bitcoin的钱包地址==。**相比Base64，Base58不使用数字"0"，字母大写"O"，字母大写"I"，和字母小写"i"，以及"+"和"/"符号**。

设计Base58主要的目的是：

1. **避免混淆**。在某些字体下，数字0和字母大写O，以及字母大写I和字母小写l会非常相似。
2. 不使用"+"和"/"的原因是，**非字母或数字的字符串难以作为账号的一部分被接受**。
3. **没有标点符号，通常不会被从中间分行**。
4. **使大部分的软件支持双击选择整个字符串**。

**比特币中使用Base58算法来对公钥的Hash160及私钥进行编码，以生成以1或3开头的比特币地址及WIF（Wallet import Format)格式的私钥**。

### 私钥与公钥

**比特币私钥其实是使用SHA-256生成的32字节（256位）的随机数，有效私钥的范围则取决于比特币使用的secp256k1 椭圆曲线数字签名标准**。大小介于0x1 到0xFFFF FFFF FFFF FFFF FFFF FFFF FFFF FFFE BAAE DCE6 AF48 A03B BFD2 5E8C D036 4140之间的数几乎都是合法的私钥。

**在私钥的前面加上版本号，后面添加压缩标志和附加校验码，（所谓附加校验码，就是对私钥经过2次SHA-256运算，取两次哈希结果的前四字节），然后再对其进行Base58编码，就可以得到我们常见的WIF（Wallet import Format)格式的私钥**。

**私钥经过椭圆曲线乘法运算，可以得到公钥**。公钥是椭圆曲线上的点，并具有x和y坐标。公钥有两种形式：压缩的与非压缩的。早期比特币均使用非压缩公钥，现在大部分客户端默认使用压缩公钥。

由于数学原理，==从私钥推算公钥是可行的，从公钥逆推私钥是不可能的==。

**初识比特币的人常有一种误解，认为比特币公钥就是地址，这是不正确的。从公钥到地址还要经过一些运算**。

### 地址的生成

**椭圆曲线算法生成的公钥信息比较长，压缩格式的有33字节，非压缩的则有65字节**。==地址是为了减少接收方所需标识的字节数==。比特币地址的生成步骤如下：

1. 生成私钥与公钥
2. 将公钥通过SHA256哈希算法处理得到32字节的哈希值
3. 后对得到的哈希值通过RIPEMD-160算法来得到20字节的哈希值 ---- Hash160
4. 把版本号[2]+Hash160组成的21字节数组进行双次SHA256哈希运算，得到的哈希值的头4个字节作为校验和，放置21字节数组的末尾。
5. 对组成25位数组进行Base58编码，就得到地址。

下图以非压缩格式的65字节公钥示意上述过程：

![比特币地址算法](http://cdn2.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part03/zh/resources/001.png)

由于椭圆曲线乘法以及哈希函数的特性，我们**可以从私钥推导出公钥，也可以从公钥推导出地址，而这个过程是不可逆的**。也正因如此，在整个比特币系统中，私钥是最关键的部分。==私钥泄露也就意味着丢失了一切==。

**我们要花掉一个地址上的资产，需要构造一笔交易，同时使用这个地址对应的私钥签名**。而==如果我们要将资产转移到某个地址上，只需要转账给他公开的地址就行了==。

在下一节，我们将详细讲述比特币交易是如何构成和实现的。

## 比特币的交易

==在比特币区块链中，交易是最核心的内容==。通过前面的讲述，我们知道，**比特币通过基于密码学的公私钥体系，交易的发起者可以使用自己的私钥对交易进行签名，其他人可以使用其公钥进行验证，这就从数学上保证了用户资金的安全**。那么其交易具体是怎么构建的呢？

### 简化模型

在中本聪的白皮书里，==比特币被定义成一个链式的数字签名串==。**币的拥有者通过对前一次交易和下一次拥有者的公钥签署一个数字签名，并将这个签名附加在这笔交易的当中，来完成一笔转账**。而转账的收款人通过对签名进行验证，就能够验证该链条的所有者是不是发送方。

交易的运作图如下：

![比特币交易运作图](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/01.JPG)

==这样设计的交易体系的问题在于收款人很难校验之前的某位资产拥有者是否进行了双重支付（双花）==。通常的解决方案是引入可信的第三方，如银行，来对每一笔交易进行检验，以防止双重支付。而如果想要排除第三方中介机构，那么交易信息就应当被公开，需要整个系统内的所有参与者，都有唯一公认的历史交易序列。==收款人需要确保在交易期间绝大多数的节点都认同该交易是首次出现==。

### 账本系统不以"账户"为基础

**比特币区块链本质上可以说是一个基于互联网的去中心化的账本系统，而这个账本上记载的，就是一笔笔比特币地址之间的转账交易**，一笔具体的交易过程如上面所示，那整个系统该如何构建呢？。

常常有一种简单化的说法，将比特币公钥类比为用户的银行卡号，也即用户的账户。那么最容易想到的交易系统的记录方式是以账户为基础的，简化的示意图类似这样：

![账户为基础的交易图](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/02.JPG)

==这种记账方式是最容易想到的，然而比特币区块链并没有采用这种方式==。重要的事情说三遍，比特币的交易系统不是这样的，不是这样的，不是这样的。原因很简单，如果采用这种记账方式的话，每当要进行一笔新交易的时候，系统都不得不回溯该所有交易历史，这样才能确定最新的这笔交易是不是合法，如上图所示，用户C有这些钱吗？当系统庞大、交易数量众多的时候，每次都进行这样的检验无疑是笨重低效的。

### 那么比特币的交易系统是怎样构建的呢？

#### UTXO是比特币交易的基本单位

**==UTXO（Unspent Transaction Outputs）是未花费的交易输出，它是比特币交易生成及验证的一个核心概念==**。**交易构成了一组链式结构，所有合法的比特币交易都可以追溯到前向一个或多个交易的输出，这些链条的源头都是挖矿奖励，末尾则是当前未花费的交易输出**。==所有的未花费的输出即整个比特币网络的UTXO==。

**比特币规定每一笔新的交易的输入必须是某笔交易未花费的输出，每一笔输入同时也需要上一笔输出所对应的私钥进行签名，并且每个比特币的节点都会存储当前整个区块链上的UTXO，整个网络上的节点通过UTXO及签名算法来验证新交易的合法性**。这样，==节点不需要追溯历史就可以验证新交易的合法性==。

#### 交易的输入与输出

**比特币的交易，并不是通常意义的一手交钱一手交货的交易，而是转账**。如果每一笔转账都需要构造一笔交易数据会比较笨拙，为了使得价值易于组合与分割，==比特币的交易被设计为可以纳入多个输入和输出==。即一笔交易可以转账给多个人。**从生成到在网络中传播，再到通过工作量证明、整个网络节点验证，最终记录到比特币的区块链，就是交易的整个生命周期**。

**交易的本质是一个包含交易发送方、接收方、资产转移等相关信息的数据结构**，其数据结构如下：

字段   | 描述        | 大小
---- | --------- | --------
版本   | 这笔交易参照的规则 | 4 字节
输入数量 | 交易输入列表的数量 | 1 - 9 字节
输入列表 | 一个或多个交易输入 | 不定
输出数量 | 交易输出列表的数量 | 1 - 9 字节
输出列表 | 一个或多个交易输出 | 不定
锁定时间 | 锁定时间      | 4 字节

从整体结构来看，**交易主要的两个单元字段就是交易的输入与输出**。**输入标识着交易的发送方，输出标识着交易的接收方及对于自己的找零，交易的手续费则是输入的总和与输出的总和之差**。由于所有的交易输入必然是前面某笔交易的输出，==所以交易最核心的字段是交易的输出==。

一笔交易的数据结构图如下所示：

![比特币交易数据结构](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/04.JPG)

比特币的交易输入（TxIn）有三种，分别是**Standard TxIn（标准输入）**、**Spend Coinbase TxOut（花费挖矿奖励）**、**Coinbase/Generation（产生挖矿奖励）**，下图分别描述了这三种TxIn的结构：

##### Standard TxIn（标准输入）

![Standard_TxIn](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/05.JPG)

##### Coinbase TxOut（花费挖矿奖励）

![Spend_Coinbase_TxOut](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/06.JPG)

##### Coinbase/Generation（产生挖矿奖励）

![Coinbase_Generation](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/07.JPG)

比特币的交易输出（TxOut Script）有两种，分别是**Standard TxOut （标准交易输出）**、**Coinbase TxOut （挖矿奖励输出）**，下图分别描述了这两种TxOut的结构：

##### Standard TxOut （标准交易输出）

![Standard_TxOut](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/08.JPG)

##### Coinbase TxOut （挖矿奖励输出）

![Coinbase_TxOut](http://cdn1.infoqstatic.com/statics_s1_20160816-0334/resource/articles/bitcoin-and-block-chain-part04/zh/resources/09.JPG)

#### 脚本

==脚本是交易里另一个比较重要的技术==。**每一笔交易的每一项输出严格意义上并不是指向一个地址，而是指向一个脚本**。==脚本类似一套规则，它约束着接收方怎样才能花掉这个输出上锁定的资产==。

==交易的合法性验证也依赖于脚本==。目前它依赖于两类脚本：**锁定脚本**与**解锁脚本**。**锁定脚本是基于可变的模式，通过一段脚本语言来实现，位于交易的输出**。==解锁脚本与锁定脚本相对应，只有按锁定脚本的规则去解，才能花掉这个脚本上对应的资产，位于交易的输入==。**脚本语言可以表达出无数的条件变种**。这也是比特币作为一种"可编程的货币"所拥有的特性。而解释该脚本是通过类似我们编程领域里的"虚拟机"，它分布式运行在比特币网络里的每一个节点。

比特币的脚本目前常用的主要分为两种，一种是**普通的类型P2PKH（Pay-to-Public-Key-Hash）**，即支付给公钥的哈希即地址，==接收方只需要使用地址对应的私钥对该输出进行签名，即可花掉该输出==。另一种是**P2SH（Pay-to-Script-Hash）**，支付脚本的哈希。拿多重签名来举例，它要求该输出==同时要有N把私钥中的M把私钥（M<=N）同时签名才能花掉该资产==，它类似于现实生活中需要多把钥匙才能同时打开的保险柜，只是更加灵活。

比如在比特币中，P2PKH的脚本规则如下：

```
Pubkey script: OP_DUP OP_HASH160 <PubKeyHash> OP_EQUALVERIFY OP_CHECKSIG
Signature script: <sig> <pubkey>
```

P2SH的脚本规则如下：

```
Pubkey script: OP_HASH160 <Hash160(redeemScript)> OP_EQUAL
Signature script: <sig> [sig] [sig...] <redeemScript>
```

在上述的2种脚本规则里，**Pubkey script代表着锁定脚本**，**Signature script代表着解锁脚本**。**OP_开头的单词是相关的脚本命令**，也是"虚拟机"所能解析的指令。==这些命令规则根据Pubkey script的不同来进行划分，它也决定着解锁脚本的规则==。

**比特币中的脚本机制相对简单，只是一个基于堆栈式的，解释相关OP指令的引擎，能够解析的脚本规则并不是太多，不能实现很复杂的逻辑**。但它为区块链可编程提供了一个原型，后续一些可编程区块链项目其实是基于脚本的原理发展起来的，比如以太坊，就是深入强化了脚本机制，脚本机制里不再单单是简单的OP指令，而是支持脚本语言，该脚本语言可以通过"虚拟机"去执行。==以太坊实现了一个支持图灵完备脚本语言的区块链平台==。

**脚本的机制对于区块链来说非常重要，它类似于区块链技术提供的一个扩展接口，任何人都可以基于这个接口，去开发基于区块链技术的应用**，比如智能合约的功能。==脚本机制也让区块链技术作为一项底层协议成为可能==。未来很多基于区块链的颠覆性应用，都有可能是通过区块链的脚本语言来完成的。

以上简述了比特币区块链中交易的过程和相关的重要概念。限于篇幅，在这里省略了一些可以拓展的内容。到目前为止，我们讲述的内容，包括上一节讲述的公私钥，都是与用户的使用直接相关的。关于区块链的共识机制、系统安全等广大读者关心的问题，我们会在之后的文章中为您讲解。

--------------------------------------------------------------------------------

# 区块链"五大迷思"

国际著名市场调查机构Gartner观察到，多种迹象显示自2015年8月以来大面积爆发了区块链狂热。实际上尽管到2015年底才成立了Linux基金会赞助下的HyperLedger超级账本项目，但自此之后的**该项目就从最开始的30家创始成员公司迅速扩展到55家成员，还有2300个成员申请待处理**。

Linux基金会HyperLedger超级账本项目执行董事Brian Behlendorf亦于今年7月到访中国，他介绍Linux社区对于区块链的热情远高于第二大热门开源项目。除各大技术厂商围绕HyperLedger项目迅速集结起来，世界上45大银行围绕着R3项目形成了另一大势力集团。**资本对于区块链项目也非常看好，《2014-2016全球比特币发展报告》显示区块链行业已经获得超过十亿美元的投资**。

然而，Gartner研究副总裁兼院士级分析师Ray Valdes在近日访华时指出，**区块链架构体系与当前已经运行了超过300年的商业体系机制完全对立**。那么，==对于这样颠覆性的新技术，应该采用何种策略==？

## 做好24个月就过期的准备

在Ray Valdes谈及的所有观点中，**最有价值的是企业高管和技术主管们究竟应用以何种策略或心态来看待比特币和区块链这样的新兴技术**。

Ray表示，**首先要了解区块链在全球市场的一个基本格局**。预计全球将会有30家左右的主要区块链技术供应商存在，它们互相之间竞争激烈，但却很难预测谁是最后的赢家。从长期来看，可以确定的一个判断是，==无论当前选择何种区块链技术或平台，在两年内被淘汰的可能性会很高==。

因此对于这种新技术风险，**Ray建议企业高管和技术主管们要从战略的角度去考虑**。实际上不论是区块链还是其它**热门新兴技术，在任何的投资和项目启动的决定上，都一定是战术级别**。这就意味着==尽管科技平台会不断发生演变和转换，但其核心理念将保持一致==。

那么，对于区块链这样新兴技术的态度和策略是：

- 首先要**谨慎选择一个比较合适的可以用于新技术场景的业务时刻**；
- 其次是头脑当中时刻要记住==今天的任何选择都很可能会在未来24个月内过期==，要时做好准备切换到下一个技术平台；
- 第三是一定要**在这个过程当中去学习和理解，新技术如何能够为企业创造新市场、新产品或新服务，建立新的业务模型，从而更加适合新时代的要求**。

## 区块链的五大"迷思"

**区块链的核心科技哲学**，是要==在一个分布式、去中心化的非信任环境下增加信任，并且能够形成能够在整个网络体系内传播的价值==。

Ray指出，关于区块链有五大迷思。

- 首先是==由于区块链被明确设计为去中心化，导致其可扩展性和规模化能力较差==。比特币区块链是当前唯一在现实世界中可用的一种作业系统级别、大规模的区块链，但是因为**比特币区块（Block）最大限制为1MB、确认延迟为10分钟，这导致它执行的速度只能达到七笔交易/秒（tps），远低于Visa的峰值处理能力47,000 tps**。

- 区块链的第二大迷思，是==有许多人会认为比特币区块链支持实时付款==。这样的一种迷思的错误，**在于比特币区块链形成一条记录最少需要十分钟，有的情况下需要一个小时甚至更长的时间**。==理论上，攻击者可以建立另一链分支链，从而形成双重开支==。

- 区块链的第三大迷思，即去中心化。==有许多人认为区块链是去中心化模式==，但其实由于**整个比特币的计算资源高中集中在某些特定企业手里，即高达80%的算力集中在4家采矿池中，而且这4家全部位于中国**。因此，==这4家中的任意两家在理论上都可以串通起来控制账本==。

- 区块链的第四大迷思，在于==有许多人认为区块链账本是不可篡改的==。但实际上**以比特币区块链为例，粗略估算任何第三方只要有4亿美元的资金，就能够改写整个区块链账本直至第一个初始区块**。

- 区块链的第五大迷思，是==有很多人认为区块链是"魔力"数据库技术==。其实**区块链的账本采用的是扁平文件，是简单交易记录的线性列表，而且这个列表只能添加而不能删除记录，因此文件规模在无限增长**。==目前比特币区块链账本已达50GB，还必须在网络中的每个节点都复制==。

当然，**现在很多金融机构和技术企业都对区块链的概念非常感兴趣，正在通过技术改良来克服比特币区块链的种种弊端**，==但到目前还都处于设计或者提议阶段，尚未付诸实践==。

## 颠覆者将来自局外人

Ray谈到当前全球有30家左右的技术供应商在争夺区块链的技术话语权。但从历史经验来看，目前比较成熟的技术供应商，往往难以在最终的淘汰赛中保持到最后。

追溯到3W时代和电商时代，当时形成的亚马逊、天猫、阿里巴巴、淘宝、Facebook、百度等企业，都不是在互联网诞生之初就已有的传统技术供应商。"==在下一个阶段，我们将会进入一个叫做钱联网或者是叫做价值互联网==。在这样一个阶段，如同原来的数据互联网和内容互联网一样，**最终胜出的科技企业应该不是比较成熟的企业，而是从新公司中诞生**。"

一家成立于2013年名为Circle的数字支付公司，提供数字货币储存及国家货币兑换服务的消费金融服务。使用Circle的APP，用户可以在无需手续费的情况下，以发送消息的形式发起即时的转账、收付款，类似于微信里的实时转账，==基于区块链技术Circle还可实现全球范围的货币流转==。今年6月，Circle宣布获得6000万美金D轮融资。

==Gartner认为区块链总体上属于可编程经济==，**但通向可编程经济的道路十分漫长，可能需要数十年的时间**，这就如同互联网和网络经济也是各自耗费几十年的时间才充分发展起来一样。从中短期看，==企业需要为面对多个区块链并存的世界做好准备==。

--------------------------------------------------------------------------------

# 什么是区块链？

一说道区块链，就必须提到"中本聪"和这位神秘人物发明的比特币。比特币正是基于区块链这个核心技术，才得以相对稳定地发展到今天。中本聪发明比特币之时，要实现的是==电子货币去中心、匿名化的信用系统==，必须避免任何对第三方的依赖，如银行。

由此，区块链就应允而生。具体的定义是：

**区块链(Blockchain)是在没有中央控制点的分布式对等网络，使用分布式集体运作的方法，实现一套不可篡改的，可信任的数据库技术方案，其特点为去中心化存储、信息高度透明、不易篡改等**。

通俗一点说，==区块链就是利用计算机程序在全网记录所有交易信息的"公开大账本"==。

- 区块链网络中的节点，通过计算一个艰难的计算问题，来获得**记账的权利**；
- 任何区块链网络上的节点，都**可以观察到整个总账**；
- 区块链数据**由每个节点共同维护**，每个参与维护节点都能复制获得一份完整数据库的拷贝；
- 当你要发起一笔交易的时候只需把**交易信息广播到p2p网络中**，你的交易信息会被记录成一个新的区块连到区块链上，交易就完成了；
- 除非能够同时控制整个系统中超过 51%的节点，否则**单个节点上对数据库的修改是无效的**，也无法影响其他节点上的数据内容。

**区块链具有可信可追溯性、不可摧毁、不可篡改、开源可共享、智能管理等特性，使得其拓展应用有很大的潜力**。

区块链有几种类型：

- 公有链（公开、所有人可自由访问）
- 行业链（或联盟链，半公开，行业内部使用，外部仅可以授权查询）
- 私有链（仅内部使用）

## 区块链的应用有哪些？

我们可以把区块链的发展类比互联网本身的发展，未来会在internet上形成一个比如叫做finance-internet的东西，而这个东西就是基于区块链，它的前驱就是bitcoin，即传统金融从私有链/行业链出发（局域网），bitcoin 系列从公有链（广域网）出发，都表达了同一种概念----数字资产（Digital Asset），最终向一个中间平衡点收敛。

区块链的进化方式可以是：

- 区块链1.0 - **数字货币**
- 区块链2.0 - **数字资产与智能合约**
- 区块链3.0 - DAO/DAC（**区块链自洽组织/区块链自洽公司**）
- 区块链4.0 - 区块链大社会（**科学、医疗、教育、区块链+人工智能、区块链+能源**）。

## 区块链+电网能干什么？

能源行业正在发生深刻的变革，**能源互联网、碳交易、电动汽车+智能交通的兴起、分布式新能源+储能、智能电网**......这些变革和区块链的去中心化、开源共享以及智能管理似乎有着天然的契合性，那么能源区块链到底能干什么？下文来自刘子榆发表在雷锋网的《区块链技术如何重构未来电网布局》。

==电力将很快能够被民所制，为民所享。而区块链技术，将成为制胜的关键==。

也许在未来的一天，电力的布局将会和今天完全不同。人类可能不再需要大型电厂通过远距离将电输送到每家每户，而是可以通过太阳能电池板，由地方居民自己生产电力，自己使用。届时，**人类将同时充当着电力的生产者，销售者和消费者三种角色**。

据未来能源主义者描述，人们可以**利用区块链技术，在相应的系统中记录电力流向**。他们相信，正如账本可以使得人们跟踪和验证货币的交易那样，区块链作为比特币的一种概念，也可以通过分散的网络帮助调解能量单位的交易。

**使用区块链来进行能源交易**，这个愿景是由一个欧盟资助的组织scanergy-project的研究者MikeMihaylov提出的。使用一种去中心化的方式来促进点对点交易，居民可将自家太阳能板产生的过剩电力出售给对面街道的家庭，交易以区块链网络连接，几乎不需要人员参与就可以管理记录交易。Mihaylov希望可以在不久的将来，在电力行业能够看到"生产型消费者"的出现。即人们通过使用一种叫做NRGcoin的货币进行电力的交易。并且，Mihaylov已经基于此想法建立了一个原型。

如果有居民拥有一些不需要的，多余的电力能源，那么他就可以将其存储在本地的智能电网中。并且每千瓦时会获得一个NRGcoin货币。同样，如果有人因为一些原因而需要更多的能源，而他的太阳能电板无法满足其需求时----也许是在阴天。那么他就可以以同样的价格在智能电网中买到他需要的能源。除此之外，居民也可以通过售卖自己的NRGcoin货币来获得更多传统意义上的电能。

## 如何破局?

"使用NRGcoin货币的好处主要有三点，"Mihaylov说，

"首先，这会是一个很好的激励消费者进入市场的方法，因为他们同时也是电力的生产者，这会给电力市场带来新的活力。再者，电力的价格已经被系统控制在一个合理的范围内，就算政府再开发出新能源，也不会使得市场的交易价格过于混乱。并且，电力零销商也不需要进行实际意义上的金钱交易，而是可以用一种特定的专有货币进行交易，这是十分便利的。"

区块链作为底层技术，已经被广泛应用在金融、能源等领域。在特高压和智能电网技术逐步成熟、清洁能源迅猛发展的趋势下，由亿万终端组成的全球能源互联网将加快构建。而区块链技术具有**去中心化存储、信息高度透明、不易篡改**等优势，能**==实现能源的数字化精准管理==**，对于重构电力交易的发展潜力极其巨大。

Mihaylov说，"我已经做好了理论准备并且测试已经完成，现在，是时候把它转化为现实了。"

不过，虽然业界对于使用区块链进行能源交易很感兴趣(比如在布鲁克林进行的一个著名试验)，但是能源市场依旧受到高度管制，变化是比较缓慢的。Mihaylov要完成这一愿望可能还需要面临多种困难和阻碍。

令人欣慰的是，在能源行业，似乎所有的变化都是有可能发生的。也许在未来，我们真的会与自己的邻居进行电力的分享和交易。

--------------------------------------------------------------------------------

# 曹寅：把区块链作为分布式售电解决方案

能源互联网暨"一带一路"高峰论坛，将于11月9-10日，在上海隆重召开！最新确认的演讲嘉宾有**李俊峰、曾鸣、何继江、刘惠萍、廖宇、曹寅、曹军威**等，大咖云集！

在近期举行的峰会上，信达证券能源区块链首席专家曹寅进行了演讲，主题为"==把区块链作为分布式售电解决方案=="。

大家好，为了控制时间，我先设一个闹钟，到了时间会提醒我。我主要跟大家介绍一下能源和区块链结合，我称之为是==能源互联网2.0时代==，之所以如此称呼，是因为**现在所提倡的能源互联网1.0理念，有很多难以落地的问题**，比如说在多对多市场化交易和服务时的信任传递的问题，以及为了在目前架构下确保信任所需要依赖的第三方成本过高的问题，都是能源互联网1.0概念面临的挑战。

**因此我们提出能源区块链概念，致力于把能源和先进信息技术进行深入的结合，从信息技术和金融角度解决目前能源互联网落地钟碰到各种各样的问题**。

今天主要是讲两个问题，区块链什么，在座很多的朋友从能源行业出身，从区块链这种新兴信息技术不是特别了解，第二，我会介绍一个能源区块链的应用案例，来看看，在区块链之上，我们能源行业如何解决现实问题，为社会创造价值。

其实区块链是生产关系不停发生变化带来必然的结果，技术不多讲了，它本身作为==去中心化的分布式共享账本技术，用密码学确保信息加密，并通过分布式数据架构实现信息公开，在公开和加密之间实现了完美的平衡==。区块链的底层技术都不是新的技术，像P2P动态分布式组网技术，密码学，智能合约等。

**以区块链为底层技术的下一代互联网生态圈正在出现，基于基础应用，我们整个商业价值观必须发生大的变化，未来商业之间，企业和企业，生产者和供应者，融资者和投资者商业壁垒会消失，大家会成为融合的生态，这样会有很多新的生态会出现，形成大家你中有我，我中有你的共享化新生态**。

我们可以构建==自动化的智能合约==，我们认为是未来称之智能经济的底层技术，基于区块链上布置的智能合约，我们可以设计一个崭新的自动化能源经济，比如**智能的个性化电价方案**，**自动执行和考核的需求侧响应**，不需要相关组织，机构和公司来进行人为的执行和考核，大大降低能源行业大量不必要的管理和运维成本。

刚刚讲了那么多区块链的作用，其目的就是打破现在割裂的能源价值链环节之间的合作壁垒，形成融合共享新的生态，在新的生态里面所有的企业，所有的参与者都是平等的。

在区块链技术中，所有参与者都是分布式帐本的维护者，可以按需写入和读取账本中数据，同时，还可以授权第三方开发的智能合约调用分布式账本中的数据，以实现智能化的智能合约应用。

当然，目前区块链技术的缺点也相当明显，目前区块链技术可以用"==不成熟=="来概括，主要是技术比较不成熟，里面涉及到交易效率的问题，同时安全性方面相对来说，虽然做到多点备份的安全冗余，但是代价则是黑客可以攻击的数据节点也多了，对区块链技术来说，需要新的安全思维来考虑。对目前信息安全解决方案无法保护未来区块链上共享的数据库，还有，目前区块链人才也跟不上，这些问题都是限制区块链应用发展的瓶颈。

区块链的技术特点与能源互联网的理念是具有较高相关性，==未来能源发展趋势和区块链的分布式，协作化，开放化的态势一脉相承==，所以区块链和未来的能源互联网可以有完美的结合，至于应用如何落地，我们现在正在设计分布式光伏售电模式。

**目前的分布式光伏售电的价值链看起来比较简单，屋顶，业主，电网公司，电站业主和电站投资者，看起来比较简单，但刚才展示的其实是理想情况，现实当中牵扯非常多的其他参与方，比如各种各样的第三方机构，他们起到的作用其实就是确保价值链之间能够实现信任有效传递，由于目前中国企业诚信环境是非常差的，同时由于经济原因，企业营商环境不是特别好，导致电站售电的非必要成本非常高**。

这对平价上网是无疑是很大的挑战，而且**在能源互联网时代，能源价值链所有环节都将是融合的**，所以如果把分布式光伏售电放在能源互联网的大背景下来看，这么一个小的环节复杂性将呈现指数级别上升。

而我们正在设计的==基于区块链的分布式售电解决方案==，把刚才所提的几个环节并行融合一体，在区块链上实现数据布置，所有购售电参与者共同维护同一个区块链上的大帐本，==实现以技术手段为保证的自证其信==。同时，大量在区块链上布置的用电数据，还可以成为其他能源互联网应用的数据来源。

目前在纽约布鲁克林也在做类似的方案，但他们目前涉及到技术上的问题，可以做10户人家，却无法扩展到电网级别，甚至仅仅是微电网级别的电力交易。我们建了全世界第一个能源区块链实验室，我们目前也是全球最精英的区块链合作社Hyperledger Project的唯一能源企业成员，我们同国际顶级的区块链企业和金融企业共同开发覆盖能源全领域的区块链解决应用。这是我们的早期一些的应用，三条产品线，能源金融，能源运维等等。由于时间限制，我的演讲就到这里。

--------------------------------------------------------------------------------

# 曹寅：能源+区块链 是美好未来还是题材炒作？

本文根据能源区块链实验室创始合伙人、信达证券首席区块链专家、首席能源互联网研究员曹寅题为《能源+区块链，美好未来还是题材炒作》的分享整理。

以下是曹寅在钛坦白分享的干货，由钛媒体整理：

大家好，我是能源区块链实验室创始合伙人、信达证券首席区块链专家、首席能源互联网研究员曹寅。能源区块链实验室是全世界唯一的能源区块链应用研究实验室，也是HyperledgerProject唯一的能源行业成员。很高兴今天在钛坦白跟大家交流。

## 能源行业的发展趋势

现在都在提倡能源互联网，而能源互联网的背景是未来能源行业的发、输、用、储以及金融交易等环节都会发生巨大变化。

1. **发电**。未来会从现在单一的集中式的大型电源过渡到==集中式电源和分布式电源相互和谐存在==，在部分可再生能源资源禀赋比较好的地区，分布式可再生能源甚至可能成为主电源。那时候就会带来问题，因为==分布式的可再生能源的管理比较困难==，比如风电、光电等大规模随机性自然能源，比现在的大型火电、大型核电管理的难度更高。

2. **输电**。因为电源在发生变化，电网自然也会发生变化。电网的变化是因为大量分布式可再生能源，使电网的拓扑结构会从现在远距离、高电压、大型甚至是跨国的超大型电力网络，变成==既有超大型的特高压网络又有区域级别的小型微型网络共存的一种新的电网拓扑结构==。

3. **消费**。能源消费将是在能源互联网当中最重要的板块，消费者在能源互联网时代其角色将不仅仅是单纯的消费者，而是以另外一种新的形态出现，称之为prosumer。就是==既是生产者（Producer）又是消费者（Consumer），拼在一起就是产销者（Prosumer）==。未来，消费者既可以通过自有的分布式可再生能源来发电，更重要的是还可以通过智慧能源解决方案，提供==用户侧的负荷资源参与需求侧响应==。消费者可以通过需求侧响应计划，积极的参与社区需求侧响应项目，还可以作为虚拟电厂成员加入虚拟电厂项目，同时还可以通过电动汽车、储能设施，返售电给电网。

4. **储能**。以前储能主要指的是抽水蓄能电站这种大型储能，但是随着现在电化学技术的快速发展，以及电动汽车快速发展之后，电化学电池的产量快速上升，使得储能用电池成本也快速下降。储能在很多区域已经有了经济使用价值。比如==在一些可再生能源资源特别丰富，同时电力价格比较高的地区，布置电化学储能电池就可以电价套利==，为投资者以及储能所有者带来经济收益。

**未来整个能源价值链会和以前不同**。总结一下：

- **发电端随机性增加，同时也会分布化**；
- **电网的拓扑结构也会随着电源的分布化和随机化而发生变化**；
- **消费者**角色将前所未有的在整个能源行业的价值链当中被突出，**成为真正的价值链推动者和价值链龙头**，通过各种各样的智慧能源方案成为prosumer，与电源和电网进行良性的有效互动；
- **储能**作为电力价值链上的新环节，**会成为很重要的缓存和硬盘的角色**。

## 能源行业为什么需要区块链？

刚才我讲的这些看起来很美好，但是具体操作起来，电力从业者比如电网公司、专门的调度机构，以及包括能源局、发改委、地方的监管部门，就会觉得很头疼。

因为==新的电力价值链需要新的技术，更需要新的体制以及商业模式来支撑==，但目前来看，这些其实还是跟不上技术的变化。这就导致了在中国，虽然有大量优质的可再生能源，但是现在西部和北部的风电站和光伏电站经常==弃风、弃光、限电，把优质资源浪费==。

同时，消费侧这方面，在东部地区，比如北京、上海、深圳这些中国的==核心经济地区，电价又一直居高不下==。像上海，平均的工业电价基本上是一块钱，一块钱一度电看起来好像不是特别的高，但是如果说同美国甚至说同其他的一些发展中国家比起来，工业电价是倒挂的，其实是违反常态的。

### 所以说在未来新的能源行业形态中，技术很重要，但是==相应的市场机制也非常重要==，这就是目前能源互联网所缺乏的。

我作为"中国能源互联网行动计划"的参与者之一，参与过相关研究，当时写该计划的时候其实就考虑了很多机制设计的问题，也提到过"绿币"，相当于是区块链技术在能源互联网里面的应用，但是因为当时区块链技术并不成熟，就没有把区块链作为能源互联网的一种技术解决方案放到行动计划里面。但是我个人一直认为，==区块链和能源互联网是天作之合==。

### 能源互联网作为一种解决方案，其实是难以落地的，因为现在所推行的能源互联网的理念和概念其实有非常多的缺陷。

就拿能源互联网提倡的五大特点来分析：

1. **精确计量**。**计量是对于现在各种能源系统运行状态的广泛数字化感知是控制的基础，是能源信息化的源头**。但是，精确计量可以做到，==如何保证不同参与主体对于计量数据的共识信任==？

2. **泛在交互**。在能源互联网系统中，**能源信息要做到无阻的流动，传感器设备和主体之间要形成充分的交互，实现主体和主体之间的交互，人和系统，人和设备之间的交互**。但泛在交互的前提是信任，==在信任薄弱的前提下，如何实现不同法人主体的设备和系统之间的数据调用以及互操作==？

3. **自律控制**。设备和系统要做到基于本地指令的动态响应，其目的就是要提高系统的运行效率和可靠性，这是为了应对在能源互联网当中大量的分布式本地能源。**利用本地信息实现快速的系统控制以及调度指令的下达称为自律控制**。但是问题就来了，==在自动化系统中，谁对外部数据和指令签发信任==？如果采信外部数据，执行指令之后发生事故或造成损失，谁来承担责任。

4. **优化决策**。==未来的能源互联网的时代中，谁是决策主体==？如果还是以目前**中心化的信息采集-分析判断-指令传达**的流程进行决策，那==如何杜绝中心主体从自身利益出发，滥用决策权限，损害其他主体利益==？毕竟这样的事情一直在发生。如果**采用分布式决策，大量能源互联网设备之间直接点对点交互，需要多次复杂迭代，取得共识的效率极低，甚至还可能会导致死循环无共识**。

5. **广域协调**。广域协调指的是**能源系统的参与者之间通过广域协调形成有效的机制，提供合理的信号，激励在系统内和系统外的参与者，然后基于自身利益以及整个系统的利益最大化，协调互动和博奕的行为称为广域协调**。问题又来了，协调的前提是取得相关主体之间的共识，==在信任脆弱、主体间关系错综复杂的条件下，如何低成本高效率的取得共识==？更何况是在不同价值域之间取得共识，协调利益。

## 那么，区块链如何解决能源互联网1.0时代的这些不能落地的问题？

1. **从精确计量升华到保护隐私、可信计量**：==数据布置在区块链上，确保不可篡改，公私钥结合的非对称加密保护隐私==。

2. **从泛在交互升华到强制信任，泛在交互**：==以可信计量为基础，通过区块链构建能源互联网交互主体之间的低成本的信任传递链条，实现基于信任的能源互联网主体间互操作性==。

3. **从自律控制升华到虚实一体、智能自律控制**：==通过链上代码，实现以智能合约为表现形式的逻辑功能，并结合区块链技术+大数据技术+人工智能技术，设计可信任的预言机制对外部数据签发信任，然后输入智能合约，执行逻辑过程，产生可信任的本地指令，在本地完成应对随机外部环境变化的控制过程==。

4. **从优化决策升华到间接民主、分布决策**：==基于区块链部署的能源互联网设备间点对点交互，形成分区局部共识，再实现分区间共识，避免大量分布式设备之间为了产生直接共识而导致的复杂迭代和死循环无共识，从而可以在实现分布式决策的同时又可以兼顾效率==。

5. **从广域协调升华到集群智能、广域融合**：==以区块链为工具，以低成本信任传递为手段，实现在能源互联网中不同能源主体，以及不同能源系统之间的能量流、信息流、资金流的强耦合，进而将不同主体和不同系统化零为整，融合为一个能源互联网超级主体，在广域内形成集群智能==。

### 通过区块链完全可以把目前能源互联网概念升华到能源互联网2.0时代新形态。

而且，区块链技术其实和能源互联网有非常强的内在一致性：

- 第一，**都强调去中心化**，比如能源互联网中电源的分布式，以及消费者及生产者之间的新关系，其实都是去中心化在能源行业的着重体现；

- 第二，**都有自治性或者说自律性**，在能源互联网里面也特别强调系统和设备以及主体的生态化自治运行，和区块链的自治性是完美的结合；

- 第三，**都重视市场化**，区块链本身是一种金融科技，它和未来能源互联网的市场化和金融化是天作之合；

- 第四，**智能化、合约化**，未来==基于自律控制的智慧能源系统里面大量的调度行为、交易行为以及交互行为和其他决策行为都是基于环境数据的自动出发的==。而其逻辑代码早在设计的时候就已经嵌入进去了，这和区块链的智能合约完全是一脉相承。

## 海外的能源区块链应用

相信很多研究区块链或能源的朋友，都研究过美国的布鲁克林区块链微网售电项目，这是在比微网还小的纳网里面做的，才10户人家的区块链的点对点售电的光伏项目。10户人家的屋顶上都装了几块光伏组件，形成了十个节点的小型区块链。这个项目是基于以太网开发的，再通过用户节点和节点之间的交互，形成了基于区块链的售电应用。该项目目前还没有看到运行测试的结果和报告，但我觉得这代表了一种方向。

不过这种应用会有约束性：

- **第一是政策约束性**。举个最简单的例子，在这个售电项目当中，==如何开发票==？这是很典型的中国问题，美国人根本不考虑发票这种问题的，最多搞个invoice给你，但是在中国，售电公司不开发票，别人得跟你急；==其次是电力销售的牌照==，你就算是卖一度电也是售电，而现在的《电力法》非常明确地规定，只有电网公司才可以售电。所以说如果你把屋顶上的电通过区块链卖给你邻居，在中国就是非法售电。

- **第二是技术约束**。在十户人家组成的超小型的纳网里面，可以实现这样分布式光伏的点对点售电，但微网会大很多，==如何来实现可扩展性==？同时，要实现的不仅仅是光伏售电，还有储能售电、电动汽车售电，甚至还有售气、售水、售热等不同能源品种之间互相的销售。此外，==这样的成百上千户的微网用户如何布置节点==？其实是很难的，因为在区块链里节点数量的增加带来的布置难度是指数级别上升的。

- **第三是安全问题**。电力、能源不像其他的行业，最主要的属性不一定是TPS，反而是==安全性、可靠性、鲁棒性==。目前的信息安全解决方案，我相信肯定不适用于未来基于区块链的电力信息网络。

所以，包括布鲁克林区块链微网售电项目、德国RWE的基于区块链做电动汽车小额支付的应用，都属于实验阶段。目前全世界对于能源和区块链的结合实践，屈指可数，少之又少，而且大部分其实都是停留在小规模实验，甚至就连POC都没有，而且最后的实验报告也没出来。

## 能源区块链实验室正在考虑的应用场景

区块链是一种应用级别技术。把区块链的应用场景分成不同的环节，有发、输、储、用这样四个环节进行设计。

**在发电领域，就是区块链售电**。这是很重要的应用场景，尤其是分布式能源基于微网的区块链售电，为什么呢？因为电力不像金融产品，上海的上市公司可以把股票卖给北京，但是在上海的微网发的光伏电是不可能把它卖到南京，或者说也不可能卖到杭州的，因为电是有损耗的，一般来说分布式光伏在比较低的电压等级，所以你一升压一降压，一远距离传输就没了，所以分布式能源的电必须本地销纳，所以我们实验室就在设计，==基于本地的能源微网通过区块链实现这样点对点的用户和发电者之间的电力交易==。

还有一点，现在全国已经有好几个电力交易所，最大的是广东电力交易所，今天广东省的最高负荷已经超过一亿千瓦，这是中国首个超过一亿千瓦的省。像广东这样的电力交易所，主要是基于交易所内竞价交易和挂牌交易实现电力交易，但是接下来随着电力市场继续的开放，电力行业、电力金融的继续发展，未来会出现很多OTC交易就是在场外的售电公司和购售电交易，到时候就需要==通过区块链来实现售电者和购电者之间电力交易合同的场外注册==了，这也是发电的应用场景。

**电力的传输其实也可以设计成金融产品，称为金融输电权**，输电权的交易就会像发电权的或者说发电上网权的交易一样，是可以进行场内交易和场外交易的，是可以形成资源在交易所内的撮合交易和挂牌交易的，所以基于输电行业环节的区块链应用场景就出现了。

**在输电行业还有另外一种应用，就是线损**。目前是电网公司说了算，包括==不同能源之间转换的损耗，比如说P2G（PowertoGas），就是多余的电变成氢气进行传送，以及热电联供、热电互换其实都是不同品种的能源之间的转换，然后进行传输==。此外，能源远距离传输和其他的运行带来的线损，如何来进行公证？如何来进行确认？其实也是可以通过区块链来做。

此外，未来的电力调度被调度的客体是大量的分布式的能源，以及大量的智慧用电负荷，比如说智能的电动汽车、智能家居，未来的整个电网的调度决策以及指令和信号的本地的生成和执行的过程，也是可以通过区块链来生成的。

**最重要的就是消费，消费端的应用场景是最多的**。现在大家都在推广需求侧响应，都在推广虚拟电厂，那么==用户侧参与的过程中，其贡献如何计量==？==如何让用户得到公正评价，让资源的贡献者心服口服==？==基于贡献如何分配利益==？其实目前这些都没有好的方案。

还有目前的需求侧响应方案是封闭式的方案，就是需求侧响应的负荷集成商跟别人签好了协议，有了需求侧响应的符合相应的指令之后，他再分配到下面的负荷让大家参与响应，但是未来在能源互联网时代，应该是即插即用、即插即发、即插即响应的可扩展的情景。在这样情景里面，==非响应计划内的负荷如何及时的参与，动态的来参与符合需求侧的响应将是非常大的挑战==。如何确定计划、如何分配收益、如何来考核，都是很困难的，而恰恰是区块链可以做到的。目前正在开发的应用是==基于需求侧响应的KPI的考核，以及自动化的基于智能合约的需求侧响应的收益的分配的应用==。

**未来的储能，更可能是称为是基于分享经济的储能**。储能的利用率单体就是单个企业购买储能的利用率其实是非常低的，不可能一天24小时都把储能电池用起来，所以说在区块链技术之下，就可以把储能当做是滴滴和Uber的出租车一样，周边的用户都可以通过使用权的分享，去调用在某用户名下的储能设施，然后付钱基于储能的收益，付使用费给储能的所有者。

所以，**在能源互联网里面，发、输、变、配、售、用等各个领域都可以和区块链结合起来**。所以说我一直呼吁能源行业的人，看到任何场景都要有敏感性，要知道如何把能源行业这些业务搬到区块链上，同时还得不能人云亦云的去考虑这些区块链应用。

**区块链目前来说，其状态就是非常不成熟**。从它的性能，包括它的信息安全方案，都不足以支撑在能源行业目前的落地。所以说大家在看能源区块链应用的同时，脑子中得打惊叹号！以区块链目前的发展阶段，还需要很长的路才能在能源行业落地，才能在能源行业应用。

另外不成熟的地方在于什么呢？在于政策，能源是强监管、强政策的基础行业，技术再牛逼，政策跟不上，监管层不认是没有任何用处的。比如刚才提到售电主体的问题，区块链可以做售电，而且可以做得很好，但是监管层不给你售电牌照你就不能做售电，你就不能把你屋顶上的分布式光伏电卖给你隔壁邻居。所以说==政策是否能跟上，也决定了区块链和能源的结合在中国是否可以落地==。

第三个就是人才问题，**目前来说，能源行业特别缺乏能够把区块链技术以及其他的比如说机器学习、大数据、人工智能、物联网等先进信息技术，同能源行业本身以及同金融三者结合的人才**。同时还具备创新导向思维的人才，就更少了。

所以这是阻碍中国未来区块链技术和能源应用结合在中国落地的三座大山。

--------------------------------------------------------------------------------

# 算法演进

回首2008年，由次贷危机引发的金融危机蔓延全球，11月份，一篇名为《[Bitcoin:A peer-to-peer electronic cash system](http://www.8btc.com/wiki/bitcoin-a-peer-to-peer-electronic-cash-system)》的论文横空出世，当时只是在一小戳圈子里被讨论，大概没几个人知道论文的意义。时间的年轮很快转入新的一年，比特币第一版本代码发布，1月4日，创世块被挖出来，5天之后，第二个块产生，比特币网络正式启动，一个自称"中本聪"的人悄悄在互联网应用这片汪洋大海吹起一片涟漪，时至今日，这片涟漪已形成滔滔大浪。

当年能读懂大神论文的人，大多惊讶于这套系统的简洁和完美，甚至有人断言此物一出，开天辟地。如今近乎8年过去，当年看起来近乎完美的系统理念，在各个方面都有长足探索和发展。接下来我将写一系列文章，回顾区块链核心技术演进之路。包括算法演进，挖矿演进，共识机制演进，代币演进，隐私的演进，以及容量和速率的演进等。题目比较大，抛砖引玉，望读者指正和补充。

关于"算法"一词，目前国内用户使用的比较模糊，有时指共识机制，比如POW算法，POS算法；有时指具体的Hash算法，比如SHA256，SCRYPT。应该说这是由于早期从外文资料翻译过来概念模糊导致的错误，后来人云亦云。共识机制（以前一般叫Proof，现在经常使用Consensus）和算法（Algorithm）在英文资料里语义清晰，不能混为一谈，两者都是区块链技术体系里的重要支柱。

因此当我们说"X币使用Y算法"的时候，其实具体指的是采用何种Hash算法，而且隐含的前提条件是这个币使用POW证明方式。只有在POW下讨论选取何种算法才有意义，算法的各种复杂设计才能体现其用处。为什么呢，中本聪在设计比特币的时候其实有很多地方用到Hash函数，比如计算区块ID，计算交易ID，构造代币地址等。我们说的算法具体是指用何种Hash函数计算区块ID，所谓算法创新也就是在这个地方下功夫。此外其他任何用到Hash函数的地方，对计算难度没有要求，而且应该选用可以快速运算的算法，尤其在计算交易ID时候，不然影响区块链同步速度。因此如果选用POS方式，计算区块ID也应该使用容易运算的算法。

## Hash函数

如上所言，我们经常说的POW算法本质是一个Hash函数。Hash函数是一个无比神奇的东西，说他替中本聪打下了半壁江山一点不为过，学习比特币应该从学习Hash函数入手，理解了Hash函数再去学比特币原理将事半功倍，不然将处处感觉混沌，难以开窍。而中本聪也将Hash函数的所有特性使用得淋漓尽致：

![p1](http://7fvhfe.com1.z0.glb.clouddn.com/wp-content/uploads/2016/10/p11.png)

已经有很多Hash函数被设计出来并广泛应用，不过Hash函数一般安全寿命都不长，被认为安全的算法往往没能使用多久就被成功攻击，新的更安全的算法相继被设计出来，而每一个被公认为安全可靠的算法都有及其严格的审计过程。在币圈中我们经常说某某币发明了某种算法，其实主要都是使用那些被认证过的安全算法，或是单独使用，或是排列组合使用。

## SHA256

SHA (Secure Hash Algorithm，译作安全散列算法) 是美国国家安全局 (NSA) 设计，美国国家标准与技术研究院 (NIST) 发布的一系列密码散列函数，经历了SHA-0，SHA-1，SHA-2，SHA-3系列发展。NSA于2007年正式宣布在全球范围内征集新新一代（SHA-3）算法设计，2012年公布评选结果， Keccak算法最终获胜成为唯一官方标准SHA-3算法，但还有四种算法同时进入了第三轮评选，分别是：BLAKE, GrøSTL, JH和SKEIN，这些算法其实也非常安全，而且经受审查，被各种竞争币频繁使用。

比特币采用SHA256算法，该算法属于SHA-2系列，在中本聪发明比特币时（2008）被公认为最安全最先进的算法之一。除了生成地址中有一个环节使用了REPID-160算法，比特币系统中但凡有需要做Hash运算的地方都是用SHA256。随着比特币被更多人了解，大家开始好奇中本聪为何选择了SHA256，同时对SHA256的安全性发表各种意见，SHA256妥妥经受了质疑，到目前为止，没有公开的证据表明SHA256有漏洞，SHA256依然牢牢抗住保卫比特币安全的大旗。当然大家心里都明白，没有永远安全的算法，SHA256被替代是早晚的事，中本聪自己也说明了算法升级的必要和过程。

## SCRYPT

后来随着显卡挖矿以及矿池的出现，社区开始担心矿池会导致算力集中，违背中本聪"一CPU一票"的最初设计理念。在那段时间，中心化的焦虑非常严重，讨论很激烈，比特币一次又一次"被死亡"，直到现在，针对矿池是否违背去中心化原则的争论仍在继续。

无论如何，有人将矛头指向SHA256，认为是算法太容易导致矿机和矿池出现，并试图寻找更难的算法。

恰逢其时，使用SCRYPT算法的莱特币（Litecoin）横空出世。据说SCRYPT是由一位著名的黑客开发，由于没有得到诸如SHA系列的严格的安全审查和全面论证，一直没被广泛推广使用。与SHA256算法相比，SCRYPT占用的内存更多，计算时间更长，并行计算异常困难，对硬件要求很高。很显然，SCRYPT算法具有更强的抵御矿机性，莱特币还将区块时间改为2.5分钟，在那个山寨币还凤毛麟角年代，莱特币依靠这两点创新大获成功，长期稳坐山寨币第一宝座位置。

后来有人在SCRYPT的基础上稍作修改形成Scrypt –N算法，改进思路都一样，都是追求更大的内存消耗和计算时间，以有效阻止ASIC专用矿机。

很快，莱特币的成功催生了各种各样的算法创新，2012至2014年间，算法创新一直都是社区讨论的热门话题，每一个使用创新算法的币种出现，都能刮起一阵波澜。

## 串联算法

重新排列组合是人类一贯以来最常用的创新发明方法。很快，有人不满足于使用单一Hash函数，2013年7月，夸克币（Quark）发布，首创使用多轮Hash算法，看似高大上，其实很简单，就是对输入数据运算了9次hash函数，前一轮运算结果作为后一轮运算的输入。这9轮Hash共使用6种加密算法，分别为BLAKE, BMW, GROESTL, JH, KECCAK和SKEIN，这些都是公认的安全Hash算法，并且早已存在现成的实现代码。

这种多轮Hash一出现就给人造成直观上很安全很强大的感觉，追捧者无数。现今价格依然坚挺的达世币（DASH，前身是暗黑币，Darkcoin，）接过下一棒，率先使用11种加密算法（BLAKE, BMW, GROESTL, JH, KECCAK, SKEIN, LUFFA, CUBEHASH, SHAVITE, SIMD, ECHO），美其名曰X11，紧接着X13，X15这一系列就有人开发出来了。

S系列算法实际是一种串联思路，只要其中一种算法被破解，整个算法就被破解了，好比一根链条，环环相扣，只要其中一环断裂，整个链条就一分为二。

## 并联算法

有人串联，就有人并联，Heavycoin（HVC）率先做了尝试。HVC如今在国内名不见经传，当时还是名噪一时，首次实现链上游戏，作者是俄罗斯人，后来不幸英年早逝，在币圈引起一阵惋惜。

HVC算法细节：

1. 对输入数据首先运行一次HEFTY1（一种Hash算法）运算，得到结果d1
2. 以d1为输入，依次进行SHA256、KECCAK512、GROESTL512、BLAKE512运算，分别获得输出d2,d3,d4和d5
3. 分别提取d2-d5前64位，混淆后形成最终的256位Hash结果，作为区块ID。

![p2](http://7fvhfe.com1.z0.glb.clouddn.com/wp-content/uploads/2016/10/p21.png)

之所以首先进行一轮HEFTY1 哈希，是因为HEFTY1 运算起来极其困难，其抵御矿机性能远超于SCRYPT。但与SCRYPT一样，安全性没有得到某个官方机构论证，于是加入后面的四种安全性已经得到公认的算法增强安全。

对比串联和并联的方法，Quark、X11，X13等虽使用了多种HASH函数，但这些算法都是简单的将多种HASH函数串联在一起，仔细思考，其实没有提高整体的抗碰撞性，其安全性更是因木桶效应而由其中安全最弱的算法支撑，其中任何一种Hash函数遭遇碰撞性攻击，都会危及货币系统的安全性。

HVC从以上每种算法提取64位，经过融合成为最后的结果，实际上是将四种算法并联在一起，其中一种算法被破解只会危及其中64位，四中算法同时被破解才会危及货币系统的安全性。

![p3](http://7fvhfe.com1.z0.glb.clouddn.com/wp-content/uploads/2016/10/p31.png)

比特币只使用了一种Hash算法，假如未来某日SHA256被证明不再安全时，虽然可以更该算法，但考虑到如今"硬分叉猛于虎"的局面，届时引发动荡不可避免，但如果使用并联算法，就可以争取平静的硬分叉过渡时间。

# PRIMECOIN

正当一部分人在算法探索之路上进行的如火如荼之时，另一部分人的声音也非常刺耳，那就是指责POW浪费能源（彼时POS机制已经实现）。POW党虽极力维护，但也承认耗费能源这一事实。这一指责打开了另一条探索之路，即如果能找到一种算法，既能维护区块链安全，这些Hash运算又能在其他方面产生价值，那简直更完美。

在这条探索之路上最让人振奋人心的成果来自于Sunny King（这大神之前已经开发了Peercoin，点点币）发明的素数币（Primecoin）。素数币算法的核心理念是：在做Hash运算的同时寻找大素数。素数如今已被广泛应用于各个领域，但人类对他的认识还是有限。素数在数轴上不但稀有（相对于偶数而言），而且分布不规律，在数轴上寻找素数只能盲目搜索探测，这正是POW的特征。 POW还有另一个要求是容易验证，这方面人类经过几百年探索已经获得一些成果。素数币使用两种方法测试，首先进行费马测试（Fermat Test），通过则再进行欧拉-拉格朗日-立夫习兹测试（Euler-Lagrange-Lifchitz Test），还通过测试则被视为是素数。需要指出的是，这种方法并不能保证通过测试的数百分百是素数，不过这并不影响系统运行，即便测试结果错误，只要每个节点都认为是素数就行。

素数币其实找的是素数链-坎氏链，存在三个特定类型的坎氏素数链：第一类坎氏链，第二类坎氏链和双坎氏链。 举第一类来说明，规则是：素数链中每个数都是前一个数的两倍减一，比如：

1531，3061，6121，12241，24481

数列的下一个数48961(24481*2-1)不是素数，因而这个坎氏链的长度是5，素数币的目标就是探索更长的坎氏链（以上三类都可以）。

那么现在最重要的问题来了，如何用坎氏链来验证一个区块是否合格呢？素数币实现的细节是这样的：

1. 计算中本聪区块头Hash，hashBlockHeader = SHA256(BlockHeader)
2. 通过变换获得坎氏链的第一个数：originNum = hashBlockHeader * Multiplier

获取originNum之后就可以测试并计算素数链长度的整数部分，小数部分的计算与坎氏链最后一个非素数的跨度相关。

每个区块的乘积因子Multiplier各不相同，计算过程和hashBlockHeader相关，素数币为此对区块头进行修改，专门增加一个字段（bnPrimeChainMultiplier）来存放这个乘积因子。但是以上第一步计算hashBlockHeader时输入数据并不包含这个乘积因子，这也是为啥特别指出中本聪区块头。

由于素数在数轴上分布不均匀，且根据目前掌握的知识来看，数越大，素数越稀有，寻找难度并不是线性递增，耗时也就不可预估，但是区块链要求稳定出块。正因为这点，素数币算法没有得到热捧，但这种探索并非没有意义，利用POW工作量的"幻想"并没有停止，探索还在继续。

## ETHASH

[以太坊](http://www.8btc.com/ethereumfolk)（Ethereum）一开始就打算使用POS方式，但由于POS设计存在一些问题，开发团队决定在以太坊1.0阶段使用POW方式，预计在Serenity阶段转入POS。 以太坊POW算法叫Ethash，虽只是一个过渡算法，但开发团队一点也不含糊，一如既往发扬其"简单问题复杂化，繁琐细节秀智商"的设计风格。Ethash 是最新版本的 Dagger-Hashimoto改良算法，是Hashimoto算法结合Dagger算法产成的一个新变种。Ethash设计时就明确两大目标：

1. 抵御矿机性能（ASIC-resistance），团队希望CPU也能参与挖矿获得收益。
2. 轻客户端可快速验证（Light client verifiability）。

基于以上两个目标，开发团队最后倒腾出来的Ethash挖矿时基本与CPU性能无关，却和内存大小和内存带宽成正相关。不过在实现上还是借鉴了SHA3的设计思路，但是使用的"SHA3_256" ,"SHA3_512"与标准实现很不同。

Ethash基本流程是这样的：对于每一个块，首先计算一个种子（seed），该种子只和当前块的信息有关；然后根据种子生成一个32M的随机数据集（Cache）；紧接着根据Cache生成一个1GB大小的数据集合（DAG），DAG可以理解为一个完整的搜索空间，挖矿的过程就是从DAG中随机选择元素（类似于比特币挖矿中查找合适Nonce）再进行哈希运算。可以从Cache快速计算DAG指定位置的元素，进而哈希验证。此外还要求对Cache和DAG进行周期性更新，每1000个块更新一次，并且规定DAG的大小随着时间推移线性增长，从1G开始，每年大约增长7G左右。

## EQUIHASH

最近在国内发展势头最猛的莫过于[Zcash](http://www.8btc.com/upcoming-zcash-launch)，该币种最大的特点是使用零知识证明实现隐私交易。距离发布还有几天，但从社区讨论来看，各方矿工都已在磨刀霍霍。Zcash对于算法的选择非常慎重，在先后考量了SHA256D，SCRYPT，CUCKOO HASH以及LYRA2等算法后，最终选择Equihash。

Equihash算法由Alex Biryukov 和 Dmitry Khovratovich联合发明，其理论依据是一个著名的计算法科学及密码学问题----广义生日悖论问题。Equihash是一个内存（ARM）依赖型算法，机器算力大小主要取决于拥有多少内存，根据两位发明者的论文描述，该算法执行至少需要700M内存，1.8 GHz CPU计算30秒，经Zcash项目优化后，目前每个挖矿线程需要1G内存，因此Zcash官方认为该算法在短时间内很难出现矿机（ASIC）。此外，Zcash官方还相信该算法比较公平，他们认为很难有人或者机构能够对算法偷偷进行优化，因为广义生日悖论是一个已经被广泛研究的问题。此外，Equihash算法非常容易验证，这对于未来在受限设备上实现Zcash轻客户端非常重要。

Zcash官方团队选择Equihash完全出于抵御矿机性能的需求，他们在官方博客中也承认并不敢确保Equihash一定是安全的，并表示如果发现Equihash存在问题，或者发现更优算法，Zcash会改变POW算法。

## 总结

随着比特币、莱特币矿机相继出现，大家已经认识到没有不能开发矿机的算法，想通过改进算法来彻底阻止矿机和矿池的出现是不可能的。另外，从近几年的发展来看，矿池也没有之前想的那么可怕，甚至已经有人论证了矿池并没有破坏去中心化。但除了安全性，POW往往伴随分发代币功能，从这个角度来说，CPU算法更具公平性，用户门槛更低，这也是算法创新的驱动，从Ethash以及Equihash设计来看，目前的算法创新仍然是以追求内存高消耗为主。以此同时，社区在共识机制的探索之路上也取得很多成果。纵观当前区块链核心技术发展全局，算法创新热潮已经有所消退，但也未停止，于比特币，于区块链，于算法探索而言，都还在路上。
